## Описание Проекта

**Svoboda Hybrid Bot** — это инструмент для автоматизированного анализа и управления вашим личным аккаунтом Telegram. Он использует гибридную архитектуру:

*   **Интерфейс (Aiogram):** Вы управляете ботом через команды, отправляемые стандартному Telegram-боту, созданному через `@BotFather`. Этот бот служит пультом управления.
*   **Ядро (Telethon):** Все основные действия (анализ чатов/сообщений/контактов, их удаление) выполняются библиотекой Telethon от имени вашего **личного пользовательского аккаунта Telegram**.

**Цель:** Предоставить инструмент для быстрой "зачистки" аккаунта на основе ключевых слов, сохраняя при этом важные данные.

## Технические Особенности

*   **Гибридная Архитектура:** Сочетание Aiogram (для UI/команд) и Telethon (для действий с аккаунтом).
*   **Автоматизация Аккаунта:** Работает через API для пользовательских аккаунтов, а не через Bot API.
*   **Анализ Контента:** Сканирует сообщения на наличие ключевых слов из файла `terms.txt`.
*   **Дифференцированное Удаление:**
    *   Удаляет отдельные сообщения при малом количестве триггеров (1-3).
    *   Удаляет чаты целиком при превышении порога (`DELETION_THRESHOLD > 3`).
*   **Удаление Контактов:** Позволяет удалять контакты, не входящие в белый список.
*   **Белый Список:** Файл `white_list.txt` для защиты контактов и чатов с ними от удаления.
*   **Отчетность:** Генерирует HTML-отчет с результатами анализа.
*   **Безопасные Подтверждения:** Использует точные фразы для подтверждения необратимых действий.
*   **Асинхронность:** Построен на базе `asyncio`.
*   **Управление Состояниями:** Использует FSM (Finite State Machine) Aiogram для обработки шагов подтверждения.
*   **Опциональная Остановка:** Предлагает очистку чата с ботом и остановку после выполнения задач.

## Предварительные Требования

1.  **Python:** Версия 3.10 или выше.
2.  **Аккаунт Telegram:** Ваш личный аккаунт, который будет анализироваться и управляться.
3.  **Telegram API Credentials:**
    *   `API_ID` и `API_HASH`: Получите на [my.telegram.org/apps](https://my.telegram.org/apps).
4.  **Токен Telegram Бота:**
    *   Создайте бота через `@BotFather` в Telegram и получите его токен (`BOT_TOKEN`). Этот бот будет использоваться только для отправки вам команд и получения ответов.
5.  **Ваш Telegram User ID (`ADMIN_ID`):**
    *   Узнайте свой User ID, например, у бота `@userinfobot`. Это необходимо, чтобы бот реагировал только на ваши команды.
6.  **Менеджер пакетов `pip`.**

## Установка и Настройка

1.  **Клонируйте или скачайте репозиторий:**
    ```bash
    git clone <url-репозитория>
    cd svoboda_hybrid_bot
    ```
2.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    python -m venv venv
    # Windows
    .\venv\Scripts\activate
    # macOS/Linux
    source venv/bin/activate
    ```
3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    # Или вручную (если requirements.txt нет):
    # pip install aiogram~=3.7.0 telethon # Укажите актуальную версию aiogram 3
    ```
    *Примечание: `uvloop` (для ускорения asyncio) будет использоваться автоматически, если установлен (`pip install uvloop`), но он в основном эффективен на Linux/macOS.*

4.  **Настройте `config.py`:**
    *   Откройте файл `config.py` в текстовом редакторе.
    *   **`BOT_TOKEN`**: Вставьте токен вашего управляющего бота (от `@BotFather`).
    *   **`ADMIN_ID`**: Вставьте ваш числовой Telegram User ID. **Это критически важно для безопасности!**
    *   **`API_ID`**: Вставьте ваш `API_ID`.
    *   **`API_HASH`**: Вставьте ваш `API_HASH`.
    *   **Остальные параметры:** Просмотрите и при необходимости измените `SESSION_NAME`, пути к файлам, `DELETION_THRESHOLD`, `FETCH_MESSAGE_LIMIT` и фразы подтверждения.

5.  **Подготовьте списки:**
    *   **`terms.txt`**: Заполните файл ключевыми словами (триггерами), которые нужно искать. Каждое слово должно быть на новой строке, в нижнем регистре.
    *   **`white_list.txt`**: Заполните файл именами контактов (точно как они записаны у вас, без учета регистра) или их `@username` (также в нижнем регистре), которые нужно защитить от удаления. Каждая запись на новой строке.

## Запуск Бота

1.  **Убедитесь, что виртуальное окружение активировано.**
2.  **Запустите главный скрипт:**
    ```bash
    python main_bot.py
    ```
3.  **Первый Запуск (Авторизация Telethon):**
    *   При первом запуске Telethon потребует авторизации вашего **личного аккаунта**.
    *   Смотрите в консоль: вам будет предложено ввести номер телефона, привязанный к вашему аккаунту Telegram.
    *   Затем вам придет код подтверждения в Telegram (в чат с самим собой или на другое устройство). Введите этот код в консоль.
    *   После успешной авторизации будет создан файл сессии (`svoboda.session` по умолчанию), и в следующие разы ввод номера/кода не потребуется.
4.  **Windows Event Loop Policy:** Скрипт автоматически пытается установить правильную политику цикла событий для Windows (`SelectorEventLoopPolicy`), необходимую для корректной работы сетевых компонентов.

## Использование Бота (Команды)

Отправляйте команды вашему **управляющему боту** (которого вы создали через `@BotFather`) в Telegram. Бот будет отвечать только вам (если `ADMIN_ID` указан верно).

*   `/start`, `/help`
    *   Показывает приветственное сообщение и список доступных команд.

*   `/analyze`
    *   Запускает процесс анализа чатов вашего аккаунта через Telethon.
    *   **Внимание:** Этот процесс может занять **очень много времени**, особенно если у вас много чатов или установлен большой `FETCH_MESSAGE_LIMIT`.
    *   Бот сообщит о начале анализа и пришлет HTML-отчет с результатами по завершении. Во время анализа другие команды могут быть недоступны ("Бот занят").

*   `/delete`
    *   Работает **только после** успешного выполнения `/analyze`.
    *   Показывает список чатов, где количество найденных триггеров превысило `DELETION_THRESHOLD`, и/или список чатов, где найдены сообщения с триггерами (1-3 шт.).
    *   Запрашивает подтверждение для выполнения **всех** предложенных действий (удаление чатов И/ИЛИ удаление сообщений).
    *   Для подтверждения необходимо **точно** отправить фразу, указанную в `config.py` (`CHAT_DELETION_CONFIRMATION_PHRASE`).
    *   Любое другое сообщение или команда `/cancel` отменит операцию.
    *   **Внимание:** Удаление чатов и сообщений (если удаляются "для всех") **необратимо!** Бот может удалять только свои сообщения или сообщения в группах, где он администратор.

*   `/deletecontacts`
    *   Запускает процесс получения списка ваших контактов Telegram (через Telethon).
    *   Показывает список контактов, которые **не входят** в ваш `white_list.txt`.
    *   Запрашивает подтверждение для **необратимого** удаления всех показанных контактов.
    *   Для подтверждения необходимо **точно** отправить фразу, указанную в `config.py` (`CONTACT_DELETION_CONFIRMATION_PHRASE`).
    *   Любое другое сообщение или команда `/cancel` отменит операцию.
    *   **Внимание:** Удаление контактов **необратимо!**

*   `/clearcache`
    *   Очищает результаты последнего анализа (`/analyze`), хранящиеся в памяти бота (переменная `analysis_cache`). Не влияет на файлы или сам аккаунт Telegram.

*   `/cancel`
    *   Отменяет текущую операцию, ожидающую подтверждения (удаление чатов/сообщений или контактов).



svoboda_hybrid_bot/
├── main_bot.py # Точка входа, запуск aiogram и telethon
├── config.py # Конфигурация (API ID/Hash, токен бота, файлы, пороги)
├── shared_state.py # Общее состояние (событие остановки)
|
├── aiogram_bot/ # Модули, относящиеся к боту Aiogram (интерфейс)
│ ├── init.py
│ ├── bot_instance.py # Экземпляр бота Aiogram
│ ├── dispatcher.py # Главный диспетчер Aiogram
│ ├── routers/ # Роутеры для обработки команд
│ │ ├── init.py
│ │ ├── common.py # /start, /help, /cancel
│ │ ├── analysis.py # /analyze, /clearcache
│ │ └── deletion.py # /delete, /deletecontacts, подтверждения, очистка/остановка
│ └── states.py # Состояния FSM для подтверждений
|
├── telethon_client/ # Модули, относящиеся к клиенту Telethon (ядро)
│ ├── init.py
│ ├── client_instance.py # Экземпляр клиента Telethon
│ ├── analyzer.py # Логика сканирования и анализа чатов
│ ├── actions.py # Логика удаления чатов/сообщений/контактов
│ └── utils.py # Вспомогательные функции (получение имен, HTML-отчет и т.д.)
|
├── reports/ # Папка для сохранения HTML-отчетов
│ └── ...
|
├── terms.txt # Файл с триггер-словами
├── white_list.txt # Файл с белым списком контактов/имен
└── svoboda.session # Файл сессии Telethon (создается автоматически)


## Важные Замечания и Предупреждения

*   **НЕОБРАТИМОСТЬ:** Удаление чатов, сообщений ("для всех") и контактов через этот бот является **необратимым** действием. Восстановить удаленные данные стандартными средствами Telegram будет невозможно.
*   **ИСПОЛЬЗУЙТЕ НА СВОЙ СТРАХ И РИСК:** Вы используете этот инструмент на свой страх и риск. Разработчик не несет ответственности за возможную потерю данных или любые другие последствия использования бота.

